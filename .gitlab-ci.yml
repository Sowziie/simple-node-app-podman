stages:
  - build
  - sonar
  - docker
  - scan
  - deploy   # ajout stage deploy

variables:
  DOCKER_DRIVER: "overlay2"
  DOCKER_TLS_CERTDIR: ""
  GIT_COMMIT_SHORT: "$CI_COMMIT_SHORT_SHA"

  # SonarQube
  SONAR_HOST_URL: "http://13.222.133.90:9000"
  SONAR_PROJECT_KEY: "NodeApp"

  # DockerHub
  DOCKER_USER: "$DOCKER_USER"
  DOCKER_PASS: "$DOCKER_PASS"

  # Nexus
  NEXUS_URL: "http://13.222.133.90:8081/repository/maven-snapshots/"
  NEXUS_USER: "$NEXUS_USER"
  NEXUS_PASS: "$NEXUS_PASS"

###########################
# 1) Install dependencies & test
###########################
build:
  stage: build
  image: node:22
  script:
    - echo "ðŸ› ï¸ Installation des dÃ©pendances..."
    - npm install
    - echo "ðŸ§ª Lancement des tests..."
    - npm test || echo "âš ï¸ Aucun test dÃ©fini"
  artifacts:
    paths:
      - node_modules/

###########################
# 2) Analyse SonarQube
###########################
sonar:
  stage: sonar
  image:
    name: sonarsource/sonar-scanner-cli:11
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "sonar-cache-${CI_COMMIT_REF_SLUG}"
    paths:
      - .sonar/cache
  script:
    - echo "ðŸ” Analyse SonarQube"
    - >
      sonar-scanner
      -Dsonar.projectKey=${SONAR_PROJECT_KEY}
      -Dsonar.sources=.
      -Dsonar.host.url=${SONAR_HOST_URL}
      -Dsonar.login=${SONAR_TOKEN}
      -Dsonar.qualitygate.wait=true
  allow_failure: false

###########################
# 3) Docker Build & Push
###########################
docker:
  stage: docker
  image: docker:24
  services:
    - docker:dind
  script:
    - echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
    - docker build -t "$DOCKER_USER/nodeapp:$GIT_COMMIT_SHORT" .
    - docker push "$DOCKER_USER/nodeapp:$GIT_COMMIT_SHORT"
    - docker tag "$DOCKER_USER/nodeapp:$GIT_COMMIT_SHORT" "$DOCKER_USER/nodeapp:latest"
    - docker push "$DOCKER_USER/nodeapp:latest"

###########################
# 4) Trivy Scan
###########################
scan:
  stage: scan
  image: docker:24
  services:
    - docker:dind
  script:
    - docker run --rm \
        -v /var/run/docker.sock:/var/run/docker.sock \
        aquasec/trivy:latest \
        image --exit-code 1 --severity HIGH,CRITICAL \
        "$DOCKER_USER/nodeapp:$GIT_COMMIT_SHORT" || true
  allow_failure: true

###########################
# 5) DÃ©ploiement artefact ZIP vers Nexus
###########################
deploy:
  stage: deploy
  image: maven:3.8.5-openjdk-17
  script:
    - echo "ðŸ“¤ CrÃ©ation du package ZIP Ã  dÃ©ployer"
    - zip -r nodeapp.zip .
    - echo "ðŸ“¦ DÃ©ploiement vers Nexus"
    - |
      cat > settings.xml <<EOF
<settings>
  <servers>
    <server>
      <id>nexus</id>
      <username>${NEXUS_USER}</username>
      <password>${NEXUS_PASS}</password>
    </server>
  </servers>
</settings>
EOF
    - mvn deploy:deploy-file \
        -Durl=${NEXUS_URL} \
        -DrepositoryId=nexus \
        -Dfile=nodeapp.zip \
        -DgroupId=com.nodeapp \
        -DartifactId=nodeapp \
        -Dversion=1.0.0-SNAPSHOT \
        -Dpackaging=zip \
        -s settings.xml
    - rm -f settings.xml nodeapp.zip
